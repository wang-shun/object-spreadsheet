<head>
  <script src="/jquery/jquery-1.11.1.min.js"></script>
  <script src="/handsontable/handsontable.full.js"></script>
  <script src="/codemirror/codemirror.js"></script>
  <link rel="stylesheet" type="text/css" href="/handsontable/handsontable.full.css">
  <link rel="stylesheet" type="text/css" href="/codemirror/codemirror.css">
</head>
<body>
</body>

<template name="Spreadsheet">
  <div id="ActionBar" class="{{actionBarClass}}">
    {{> formulaValueBar}}
  </div>
  <div id="ViewWrapper" class="{{actionBarClass}}">
    <!-- Handsontable requires an inline overflow style for fixed rows/columns to work. -->
    <!-- (see WalkontableOverlay.prototype.getScrollableElement) -->
    <div id="View" style="overflow: auto"></div>
  </div>
</template>

<template name="formulaValueBar">
  {{#if loading}}
    <div>Loading... This may take a minute, especially if the sheet is being filled with a sample data set.</div>
  {{/if}}
  {{#if fullTextToShow}}
    <div>{{fullTextToShow}}</div>
  {{/if}}
  {{#each addStateCellArgs}}
    {{> addStateCell}}
  {{/each}}
  {{#each changeColumnArgs}}
    {{> changeColumn}}
  {{/each}}
</template>

<template name="addStateCell">
  {{#if canAddValue}}
  <form>
    <label for="addStateCell-value">Add value:</label>
    <input id="addStateCell-value" type="text" name="value" size="40"/>
    <input type="submit" value="Add"/>
  </form>
  {{else}}
  {{#if canAddToken}}
  <form>
    <input type="submit" value="Add object"/>
  </form>
  {{else}}
  {{#if canAddUnit}}
  <form>
    <input type="submit" value="Add X"/>
  </form>
  {{/if}}
  {{/if}}
  {{/if}}
</template>

<template name="changeColumn">
  {{! Avoid size change when drop-down boxes appear, at least in Matt's configuration.
      Total hack.  Feel free to replace with a better solution. }}
  <div style="height: 32px; margin-bottom: 4px;">
    <span style="display: inline-block; height: 25px;"></span>{{columnName}} :
    {{#if isObject}}
      {{! The below should still be half-reasonable for state keyed objects,
          even though we're deprecating them for now. }}
      {{#unless isFormula}}
        editable
      {{/unless}}
      objects
      {{#if keyColumnName}}
        generated for {{keyColumnName}}
      {{/if}}
    {{else}}
      type
      <select id="changeColumn-type">
        {{> html_select_content typeMenu}}
      </select>,
      {{! Disallowed state transitions are rejected in code. }}
      <select id="changeColumn-backend">
        {{! Doesn't buy us much in this case. }}
        {{> html_select_content backendMenu}}
      </select>
    {{/if}}
  </div>
  {{#if isFormula}}
    <div style="margin-bottom: 4px; width: 100%; display: flex; flex-direction: row;">
      {{! Wrap in div so height does not change along with formula bar when debugger is opened }}
      <div style="margin-right: 4px;">
        <button class="formulaDebuggerToggle" style="font-family: monospace;">{{#if isFormulaDebuggerOpen}}-{{else}}+{{/if}}</button>
        Formula{{#if contextText}} (in context of {{contextText}}){{/if}}:
      </div>
      <div id="changeFormula-formula" class="formula {{#if isFormulaModified}}formulaModified{{/if}}"
           style="flex-grow: 1; position: relative;">{{! height determined by code }}
        {{#if isFormulaDebuggerOpen}}
          <!-- Spacebars docs: "However, an error is never thrown when trying to index into a non-object or an undefined value." -->
          {{#each newFormulaInfo.bands}}
            <div class="formulaBand {{#if selected}}formulaBandSelected{{/if}}"
                 style="left: {{left}}px; width: {{width}}px; top: {{top}}px; height: {{height}}px;"></div>
          {{/each}}
        {{/if}}
      </div>
      <div style="margin-left: 4px;">
        <button class="saveFormula" disabled={{not isFormulaModified}}>Save</button>
        <button class="revertFormula" disabled={{not isFormulaModified}}>Cancel</button>
      </div>
    </div>
    {{#if isFormulaDebuggerOpen}}
    {{! May as well let this exist empty when no band is selected to save an afterFlush in the template. }}
    <div id="TracingView" style="width: 100%; height: 180px; overflow: auto;"></div>
    {{/if}}
  {{/if}}
  {{#if isObject}}
  <div>Display references using:
    <select id="changeColumn-referenceDisplayColumn">
      {{> html_select_content referenceDisplayColumnMenu}}
    </select>
  </div>
  {{/if}}
</template>
